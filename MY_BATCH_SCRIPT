#!/bin/bash

#SBATCH --job-name=test
#SBATCH -N 1
#SBATCH --mem=100G
#SBATCH -t 135:50:00
#SBATCH --gres=gpu:nvidia_a100_80:1
#SBATCH --partition=tier2_gpu
#SBATCH --account=aristeidis_sotiras
#SBATCH --exclude=gpu02

#SBATCH --output=slurm-%A_%a.out
#SBATCH --error=slurm-%A_%a.err

# Load modules if your cluster requires them
module load cuda/11.3
module load cudnn/8.1.1

# Step 1: Install Miniconda in /home/l.peiwang if not present
MINICONDA_DIR="/home/l.peiwang/miniconda3"
if [ ! -d "$MINICONDA_DIR" ]; then
    echo "Miniconda not found. Installing to $MINICONDA_DIR..."
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p "$MINICONDA_DIR"
    rm miniconda.sh
fi

# Step 2: Source this *new* Miniconda install
source "$MINICONDA_DIR/etc/profile.d/conda.sh"
eval "$(conda shell.bash hook)"

# Step 3: Create or update the Conda environment
ENV_NAME="pasta_env_new"

if ! conda info --envs | grep -q "$ENV_NAME"; then
    echo "Conda environment $ENV_NAME does not exist. Creating it..."
    conda env create -n "$ENV_NAME" --file /ceph/chpc/home/l.peiwang/PASTA/requirements.yaml
else
    echo "Conda environment $ENV_NAME already exists. Updating it..."
    conda env update -n "$ENV_NAME" -f /ceph/chpc/home/l.peiwang/PASTA/requirements.yaml
fi

# Step 4: Activate environment
conda activate "$ENV_NAME"

# (Optional) Install PyTorch or other packages if needed
conda install pytorch torchvision torchaudio cudatoolkit=11.3 -c pytorch -y

# Step 5: Verify
echo "Using Python from: $(which python)"
python -c "import sys; print('Python:', sys.version)"
python -c "import numpy; print('NumPy:', numpy.__version__)"
python -c "import torch; print('PyTorch:', torch.__version__, 'CUDA available:', torch.cuda.is_available())"
python -c "import torchvision; print('TorchVision:', torchvision.__version__)"
python -c "import torchio; print('TorchIO:', torchio.__version__)"

# Step 6: Run your main script
python /home/l.peiwang/PASTA/train_mri2pet.py \
    --data_dir /ceph/chpc/shared/aristeidis_sotiras_group/l.peiwang_scratch/ \
    --results_folder /ceph/chpc/shared/aristeidis_sotiras_group/l.peiwang_scratch/results/ \
    --eval_mode false \
    --synthesis false

