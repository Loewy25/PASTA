#!/bin/bash

#SBATCH --job-name=test             # Assign a descriptive job name
#SBATCH -N 1                        # Request 1 node
#SBATCH --mem=100G                  # Request 100GB memory
#SBATCH -t 5:50:00                  # Set maximum time
#SBATCH --gres=gpu:1                # Request 1 GPU
#SBATCH --partition=tier2_gpu       # Specify GPU partition
#SBATCH --account=aristeidis_sotiras
#SBATCH --exclude=gpu02             # Exclude specific nodes

#SBATCH --output=slurm-%A_%a.out
#SBATCH --error=slurm-%A_%a.err


# Load Conda
source /home/l.peiwang/miniconda3/etc/profile.d/conda.sh

# Define environment name
ENV_NAME="pasta_env"

# Create and activate the Conda environment
if [ ! -d "/home/l.peiwang/miniconda3/envs/$ENV_NAME" ]; then
    conda create -n $ENV_NAME python=3.9 -y
    conda activate $ENV_NAME
    conda env update --file /home/l.peiwang/PASTA/requirements.yaml --prune
else
    conda activate $ENV_NAME
fi

conda install -n $ENV_NAME -c conda-forge numpy torch torchvision torchaudio torchio libjpeg libpng --yes

# Load CUDA and cuDNN modules (if required)
#module load cuda/11.8 
#module load cudnn/8.1.1 

# Verify installation
python -c "import sys; print('Python:', sys.version)"
python -c "import torch; print('PyTorch:', torch.__version__); print('CUDA available:', torch.cuda.is_available())"
python -c "import torchvision; print('TorchVision:', torchvision.__version__)"
python -c "import torchio; print('TorchIO:', torchio.__version__)"

# Run training
python /home/l.peiwang/PASTA/train_mri2pet.py \
    --data_dir /scratch/l.peiwang/ \
    --results_folder /scratch/l.peiwang/results/

# Run evaluation
python /home/l.peiwang/PASTA/train_mri2pet.py \
    --data_dir /scratch/l.peiwang/ \
    --results_folder /scratch/l.peiwang/results/ \
    --eval_mode True \
    --synthesis True
